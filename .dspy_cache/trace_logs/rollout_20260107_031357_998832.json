{
  "rollout_id": "rollout_20260107_031357_998832",
  "timestamp": "2026-01-07T03:15:45.673550",
  "instruction": "# QA Engineering: cc-mirror Antigravity State Bridge\n\n## Core Mandates\n1. **90% Branch Coverage:** Achieve >90% branch coverage for all modules in `src/providers/antigravity/state-bridge/`. You MUST mock `process.platform` using `jest.spyOn(process, 'platform', 'get')` to exercise `linux`, `darwin`, and `win32` code paths within the same test suite.\n2. **Robust Session Discovery:** \n    - `getSearchPaths()` must return a deduplicated list of unique absolute paths (use `path.resolve` and `new Set()`).\n    - `findSessions()` must deduplicate sessions by their absolute `filePath` to prevent double-counting when search paths overlap.\n    - Sorting MUST be `mtime` descending (newest first).\n3. **Resilient \"No-Throw\" Parsing:** \n    - `SessionParser.parse()` must NEVER throw on malformed or corrupted JSON. \n    - If `JSON.parse` fails, catch the error and return a `ParsedSession` with `goal: \"Unknown (Corrupted JSON)\"`, `sessionId: \"corrupted\"`, and empty arrays for steps and files.\n    - Implement a `MAX_FILE_SIZE` (50MB) check before reading.\n4. **Cache Integrity:** \n    - The 60-second cache in `SessionDiscovery` must be respected. \n    - Ensure `readdirSync` is called exactly once per unique search path during the TTL. Use `jest.useFakeTimers()` to verify cache expiration.\n\n## Required Fixtures (`tests/fixtures/ag-sessions/`)\n- `simple-v1.json`: Valid v1 session with `initialPrompt` and `plan`.\n- `simple-v2.json`: Valid v2 session with `goal` and `steps`.\n- `corrupted.json`: Invalid JSON syntax.\n- `large-session.json`: Session > 1MB to test truncation.\n- `unknown-format.json`: Valid JSON but missing standard keys (tests `GenericFormatDetector`).\n\n## Critical Scenarios & Expected Outcomes\n- **Overlapping Search Paths:** If `AG_SESSION_DIR` is set to the default path, `findSessions` must still only return each session once.\n- **Permission Denied:** Catch `EACCES` errors during `readdirSync` or `statSync`; log a `console.warn` and continue with other files/directories.\n- **Context Overflow:** `ContextInjector` must truncate message content to <50KB, prioritizing `goal` and `filesModified` over `planSteps`.\n- **Stale Sessions:** Inject a warning message if the session `mtime` is older than 24 hours.\n\n## Technical Implementation Standards\n- **Mocking:** Mock `fs-extra` and `os.homedir()`. Use `jest.setSystemTime` or `jest.advanceTimersByTime` for cache tests.\n- **Path Handling:** Always use `path.join()` and `path.resolve()` for cross-platform compatibility.\n- **Error Handling:** Log warnings for recoverable errors (unreadable files) but ensure the bridge remains functional.",
  "story_context": "---\nid: \"20260107_session_discovery\"\ndifficulty: \"medium\"\ntags: [\"state-bridge\", \"filesystem\", \"typescript\", \"cross-platform\"]\ntech_stack: \"Node.js 18+, TypeScript 5.x, fs-extra\"\n---\n\n# User Story\nAs a developer switching from Antigravity IDE to Claude Code CLI, I want the system to automatically discover my AG sessions, so I can quickly continue my work.\n\n# Context & Constraints\n**Interface Requirements (SessionDiscovery):**\n```typescript\ninterface SessionDiscovery {\n  findSessions(): Promise<AGSessionMetadata[]>;\n  getLatestSession(): Promise<AGSessionMetadata | null>;\n  getSessionById(id: string): Promise<AGSessionMetadata | null>;\n}\n\ninterface AGSessionMetadata {\n  sessionId: string;\n  filePath: string;\n  timestamp: Date;\n  sizeBytes: number;\n}\n```\n\n**Platform Search Paths:**\n| Platform | Primary Path | Fallback |\n|----------|-------------|----------|\n| Linux | `~/.antigravity/sessions/` | `~/.config/antigravity/sessions/` |\n| macOS | `~/.antigravity/sessions/` | `~/Library/Application Support/Antigravity/sessions/` |\n| Windows | `%APPDATA%/Antigravity/sessions/` | - |\n\n**Performance Thresholds:**\n| Metric | Threshold |\n|--------|-----------|\n| Discovery (100 files) | < 50ms |\n| Cache TTL | 60 seconds |\n\n# Acceptance Criteria\n- [ ] **Multi-Path Search:** Check all platform-specific paths in order\n- [ ] **Environment Override:** Respect `$AG_SESSION_DIR` if set\n- [ ] **Metadata Only:** Return file stats without reading content\n- [ ] **Sorted Results:** Return sessions sorted by mtime descending\n- [ ] **Caching:** Cache results for 60s to avoid redundant I/O\n- [ ] **Error Handling:** Skip unreadable files, log warning, continue\n- [ ] **Empty State:** Return empty array if no sessions found (no error)\n",
  "code_patch": "",
  "success": false,
  "test_results": "{\"exit_code\": 2, \"stdout\": \"\\n> cc-mirror-ag-state-bridge@0.1.0 test\\n> jest --coverage --json --outputFile=test-results.json 2>&1 | tee test-output.log; exit ${PIPESTATUS[0]} --silent --json\\n\\nFAIL tests/unit/state-bridge/session-discovery.test.ts\\n  \\u25cf Console\\n\\n    console.warn\\n      Skipping unreadable session: /home/kasm-user/.antigravity/sessions/session-bad.json\\n\\n      66 |                 } catch (e) {\\n      67 |                     // Skip unreadable files\\n    > 68 |                     console.warn(`Skipping unreadable session: ${filePath}`);\\n         |                             ^\\n      69 |                 }\\n      70 |             }\\n      71 |         }\\n\\n      at SessionDiscovery.warn [as findSessions] (src/providers/antigravity/state-bridge/session-discovery.ts:68:29)\\n      at Object.<anonymous> (tests/unit/state-bridge/session-discovery.test.ts:81:46)\\n\\n  \\u25cf SessionDiscovery \\u203a findSessions \\u203a should find sessions in default path\\n\\n    expect(received).toBe(expected) // Object.is equality\\n\\n    Expected: 2\\n    Received: 4\\n\\n      43 |             const sessions = await discovery.findSessions();\\n      44 |\\n    > 45 |             expect(sessions.length).toBe(2);\\n         |                                     ^\\n      46 |             expect(sessions[0].sessionId).toBe('abc123');\\n      47 |         });\\n      48 |\\n\\n      at Object.<anonymous> (tests/unit/state-bridge/session-discovery.test.ts:45:37)\\n\\n  \\u25cf SessionDiscovery \\u203a findSessions \\u203a should sort sessions by mtime descending\\n\\n    expect(received).toBe(expected) // Object.is equality\\n\\n    Expected: \\\"new\\\"\\n    Received: \\\"old\\\"\\n\\n      56 |             const sessions = await discovery.findSessions();\\n      57 |\\n    > 58 |             expect(sessions[0].sessionId).toBe('new');\\n         |                                           ^\\n      59 |             expect(sessions[1].sessionId).toBe('old');\\n      60 |         });\\n      61 |\\n\\n      at Object.<anonymous> (tests/unit/state-bridge/session-discovery.test.ts:58:43)\\n\\n  \\u25cf SessionDiscovery \\u203a findSessions \\u203a should skip unreadable files without error\\n\\n    expect(received).toBe(expected) // Object.is equality\\n\\n    Expected: 1\\n    Received: 3\\n\\n      81 |             const sessions = await discovery.findSessions();\\n      82 |\\n    > 83 |             expect(sessions.length).toBe(1);\\n         |                                     ^\\n      84 |             expect(sessions[0].sessionId).toBe('good');\\n      85 |         });\\n      86 |     });\\n\\n      at Object.<anonymous> (tests/unit/state-bridge/session-discovery.test.ts:83:37)\\n\\n  \\u25cf SessionDiscovery \\u203a getLatestSession \\u203a should return the most recent session\\n\\n    expect(received).toBe(expected) // Object.is equality\\n\\n    Expected: \\\"newest\\\"\\n    Received: \\\"older\\\"\\n\\n      104 |             const session = await discovery.getLatestSession();\\n      105 |\\n    > 106 |             expect(session?.sessionId).toBe('newest');\\n          |                                        ^\\n      107 |         });\\n      108 |     });\\n      109 |\\n\\n      at Object.<anonymous> (tests/unit/state-bridge/session-discovery.test.ts:106:40)\\n\\n  \\u25cf SessionDiscovery \\u203a caching \\u203a should cache results for 60 seconds\\n\\n    expect(jest.fn()).toHaveBeenCalledTimes(expected)\\n\\n    Expected number of calls: 1\\n    Received number of calls: 2\\n\\n      140 |\\n      141 |             // readdirSync should only be called once due to caching\\n    > 142 |             expect(mockFs.readdirSync).toHaveBeenCalledTimes(1);\\n          |                                        ^\\n      143 |         });\\n      144 |\\n      145 |         it('should clear cache when clearCache is called', async () => {\\n\\n      at Object.<anonymous> (tests/unit/state-bridge/session-discovery.test.ts:142:40)\\n\\n  \\u25cf SessionDiscovery \\u203a caching \\u203a should clear cache when clearCache is called\\n\\n    expect(jest.fn()).toHaveBeenCalledTimes(expected)\\n\\n    Expected number of calls: 2\\n    Received number of calls: 4\\n\\n      152 |             await discovery.findSessions();\\n      153 |\\n    > 154 |             expect(mockFs.readdirSync).toHaveBeenCalledTimes(2);\\n          |                                        ^\\n      155 |         });\\n      156 |     });\\n      157 | });\\n\\n      at Object.<anonymous> (tests/unit/state-bridge/session-discovery.test.ts:154:40)\\n\\nPASS tests/unit/state-bridge/session-parser.test.ts\\nPASS tests/unit/state-bridge/context-injector.test.ts\\nJest: \\\"global\\\" coverage threshold for branches (80%) not met: 61.36%\\n\\nTest Suites: 1 failed, 2 passed, 3 total\\nTests:       6 failed, 31 passed, 37 total\\nSnapshots:   0 total\\nTime:        0.932 s, estimated 1 s\\nRan all test suites.\\nTest results written to: test-results.json\\n\", \"stderr\": \"sh: 1: Bad substitution\\n\", \"success\": false}"
}