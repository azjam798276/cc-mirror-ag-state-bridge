{
  "rollout_id": "rollout_20260107_030659_229229",
  "timestamp": "2026-01-07T03:10:18.031923",
  "instruction": "# QA Engineering: cc-mirror State Bridge Adapter\n\n## Core Mandates\n1. **90% Coverage Target:** All modules in `src/providers/antigravity/state-bridge/` must maintain >90% statement and branch coverage. Verify using `npm test -- --coverage`.\n2. **Fixture Integrity:** Use and extend the fixture registry in `tests/fixtures/ag-sessions/`. Immediately create `complex-v1.json`, `large-session.json`, and `corrupted.json` to complete the test suite.\n3. **Resilient Parsing:** The adapter must never crash on malformed input. Implement and verify fallback logic to `GenericParser` for all non-standard or corrupted sessions.\n\n## Required Fixtures (`tests/fixtures/ag-sessions/`)\n- `simple-v1.json`: Basic valid v1 session.\n- `complex-v1.json`: Multi-step session containing environment variables and nested steps.\n- `large-session.json`: Stress test fixture (>1MB) to validate memory limits and parser performance.\n- `corrupted.json`: Invalid JSON structure to test error boundary handling.\n- `unknown-format.json`: Valid JSON with an unrecognized schema to test generic parsing.\n\n## Critical Scenarios & Expected Outcomes\n- **Scenario: Empty Session Directory** -> **Result:** Log warning; proceed with null context; ensure no crash.\n- **Scenario: Parse Error/Corruption** -> **Result:** Catch exception; fallback to `GenericParser`; continue execution.\n- **Scenario: Expired OAuth Token** -> **Result:** Detect 401 or expiration state; trigger `OAuthManager.refreshSession()`; retry.\n- **Scenario: Context Size > 50KB** -> **Result:** Apply truncation strategy (prioritize latest steps); log notice of truncation.\n\n## Integration Testing Workflow\n1. **Setup:** Programmatically create a temporary AG session directory populated with target fixtures.\n2. **Execution:** Invoke `cc-mirror send --continue-from-ag` using the project's execution pattern.\n3. **Assertion:** \n    - Verify `ContextInjector` correctly transformed the session data into the bridge format.\n    - Verify the outgoing API request payload contains the expected context data.\n4. **Teardown:** Purge all temporary test artifacts and directories.\n\n## Technical Implementation Standards\n- **Framework:** Use `jest` with `ts-jest` for all tests.\n- **Mocking:** Mock filesystem operations (`fs`) for session discovery and network calls for API verification.\n- **Portability:** Use `path.join()` for all file paths to ensure compatibility across Linux, macOS, and Windows.",
  "story_context": "---\nid: \"20260107_secure_storage\"\ndifficulty: \"hard\"\ntags: [\"oauth\", \"security\", \"encryption\", \"keychain\", \"typescript\"]\ntech_stack: \"Node.js 18+, TypeScript 5.x, keytar, crypto\"\n---\n\n# User Story\nAs a developer, I want my OAuth tokens stored securely, so they can't be stolen from my filesystem.\n\n# Context & Constraints\n**Interface Requirements (SecureStorage):**\n```typescript\ninterface SecureStorage {\n  saveToken(email: string, credentials: OAuthCredentials): Promise<void>;\n  loadToken(email: string): Promise<OAuthCredentials | null>;\n  deleteToken(email: string): Promise<void>;\n  listAccounts(): Promise<string[]>;\n}\n```\n\n**Encryption Architecture:**\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 OS Keychain (keytar)                    \u2502\n\u2502 - Service: cc-mirror-antigravity        \u2502\n\u2502 - Account: encryption-key               \u2502\n\u2502 - Value: 256-bit AES key                \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                 \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Token Files (~/.cc-mirror/tokens/)      \u2502\n\u2502 - {email}.enc                           \u2502\n\u2502 - Format: { iv, authTag, data }         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\n**Security Requirements:**\n| Requirement | Implementation |\n|-------------|----------------|\n| Encryption | AES-256-GCM |\n| Key storage | OS keychain (keytar) |\n| Fallback | Machine-ID + PBKDF2 |\n| IV | Random 16 bytes per token |\n\n# Acceptance Criteria\n- [ ] **Keychain Integration:** Store encryption key in OS keychain\n- [ ] **Encryption:** Encrypt tokens with AES-256-GCM before disk write\n- [ ] **Decryption:** Decrypt tokens on load; fail gracefully if corrupted\n- [ ] **Headless Fallback:** Use machine-id + PBKDF2 if no keychain\n- [ ] **Multi-Account:** Support storing tokens for multiple emails\n- [ ] **Atomic Writes:** Use temp-file-and-rename to prevent corruption\n- [ ] **No Plaintext:** Never write unencrypted tokens to disk\n",
  "code_patch": "{\n  \"session_id\": \"f8bbabd4-64b2-4cea-aa23-91b928216876\",\n  \"response\": \"\",\n  \"stats\": {\n    \"models\": {\n      \"gemini-3-flash-preview\": {\n        \"api\": {\n          \"totalRequests\": 42,\n          \"totalErrors\": 2,\n          \"totalLatencyMs\": 171010\n        },\n        \"tokens\": {\n          \"input\": 153866,\n          \"prompt\": 779341,\n          \"candidates\": 4169,\n          \"total\": 795802,\n          \"cached\": 625475,\n          \"thoughts\": 12292,\n          \"tool\": 0\n        }\n      },\n      \"gemini-2.5-flash\": {\n        \"api\": {\n          \"totalRequests\": 1,\n          \"totalErrors\": 0,\n          \"totalLatencyMs\": 10048\n        },\n        \"tokens\": {\n          \"input\": 6219,\n          \"prompt\": 6219,\n          \"candidates\": 193,\n          \"total\": 7909,\n          \"cached\": 0,\n          \"thoughts\": 1497,\n          \"tool\": 0\n        }\n      },\n      \"gemini-2.5-pro\": {\n        \"api\": {\n          \"totalRequests\": 1,\n          \"totalErrors\": 0,\n          \"totalLatencyMs\": 13288\n        },\n        \"tokens\": {\n          \"input\": 6219,\n          \"prompt\": 6219,\n          \"candidates\": 156,\n          \"total\": 7458,\n          \"cached\": 0,\n          \"thoughts\": 1083,\n          \"tool\": 0\n        }\n      }\n    },\n    \"tools\": {\n      \"totalCalls\": 39,\n      \"totalSuccess\": 31,\n      \"totalFail\": 8,\n      \"totalDurationMs\": 34543,\n      \"totalDecisions\": {\n        \"accept\": 0,\n        \"reject\": 0,\n        \"modify\": 0,\n        \"auto_accept\": 33\n      },\n      \"byName\": {\n        \"list_directory\": {\n          \"count\": 13,\n          \"success\": 11,\n          \"fail\": 2,\n          \"durationMs\": 45,\n          \"decisions\": {\n            \"accept\": 0,\n            \"reject\": 0,\n            \"modify\": 0,\n            \"auto_accept\": 13\n          }\n        },\n        \"read_file\": {\n          \"count\": 16,\n          \"success\": 16,\n          \"fail\": 0,\n          \"durationMs\": 30,\n          \"decisions\": {\n            \"accept\": 0,\n            \"reject\": 0,\n            \"modify\": 0,\n            \"auto_accept\": 16\n          }\n        },\n        \"run_shell_command\": {\n          \"count\": 3,\n          \"success\": 0,\n          \"fail\": 3,\n          \"durationMs\": 0,\n          \"decisions\": {\n            \"accept\": 0,\n            \"reject\": 0,\n            \"modify\": 0,\n            \"auto_accept\": 0\n          }\n        },\n        \"write_file\": {\n          \"count\": 2,\n          \"success\": 0,\n          \"fail\": 2,\n          \"durationMs\": 0,\n          \"decisions\": {\n            \"accept\": 0,\n            \"reject\": 0,\n            \"modify\": 0,\n            \"auto_accept\": 0\n          }\n        },\n        \"search_file_content\": {\n          \"count\": 3,\n          \"success\": 3,\n          \"fail\": 0,\n          \"durationMs\": 28,\n          \"decisions\": {\n            \"accept\": 0,\n            \"reject\": 0,\n            \"modify\": 0,\n            \"auto_accept\": 3\n          }\n        },\n        \"delegate_to_agent\": {\n          \"count\": 1,\n          \"success\": 1,\n          \"fail\": 0,\n          \"durationMs\": 34438,\n          \"decisions\": {\n            \"accept\": 0,\n            \"reject\": 0,\n            \"modify\": 0,\n            \"auto_accept\": 1\n          }\n        },\n        \"save_memory\": {\n          \"count\": 1,\n          \"success\": 0,\n          \"fail\": 1,\n          \"durationMs\": 2,\n          \"decisions\": {\n            \"accept\": 0,\n            \"reject\": 0,\n            \"modify\": 0,\n            \"auto_accept\": 0\n          }\n        }\n      }\n    },\n    \"files\": {\n      \"totalLinesAdded\": 0,\n      \"totalLinesRemoved\": 0\n    }\n  }\n}",
  "success": true,
  "test_results": "{\"exit_code\": 2, \"stdout\": \"\\n> cc-mirror-ag-state-bridge@0.1.0 test\\n> jest --coverage --json --outputFile=test-results.json 2>&1 | tee test-output.log; exit ${PIPESTATUS[0]} --silent --json\\n\\nFAIL tests/unit/state-bridge/session-discovery.test.ts\\n  \\u25cf Console\\n\\n    console.warn\\n      Skipping unreadable session: /home/kasm-user/.antigravity/sessions/session-bad.json\\n\\n      66 |                 } catch (e) {\\n      67 |                     // Skip unreadable files\\n    > 68 |                     console.warn(`Skipping unreadable session: ${filePath}`);\\n         |                             ^\\n      69 |                 }\\n      70 |             }\\n      71 |         }\\n\\n      at SessionDiscovery.warn [as findSessions] (src/providers/antigravity/state-bridge/session-discovery.ts:68:29)\\n      at Object.<anonymous> (tests/unit/state-bridge/session-discovery.test.ts:81:46)\\n\\n  \\u25cf SessionDiscovery \\u203a findSessions \\u203a should find sessions in default path\\n\\n    expect(received).toBe(expected) // Object.is equality\\n\\n    Expected: 2\\n    Received: 4\\n\\n      43 |             const sessions = await discovery.findSessions();\\n      44 |\\n    > 45 |             expect(sessions.length).toBe(2);\\n         |                                     ^\\n      46 |             expect(sessions[0].sessionId).toBe('abc123');\\n      47 |         });\\n      48 |\\n\\n      at Object.<anonymous> (tests/unit/state-bridge/session-discovery.test.ts:45:37)\\n\\n  \\u25cf SessionDiscovery \\u203a findSessions \\u203a should sort sessions by mtime descending\\n\\n    expect(received).toBe(expected) // Object.is equality\\n\\n    Expected: \\\"new\\\"\\n    Received: \\\"old\\\"\\n\\n      56 |             const sessions = await discovery.findSessions();\\n      57 |\\n    > 58 |             expect(sessions[0].sessionId).toBe('new');\\n         |                                           ^\\n      59 |             expect(sessions[1].sessionId).toBe('old');\\n      60 |         });\\n      61 |\\n\\n      at Object.<anonymous> (tests/unit/state-bridge/session-discovery.test.ts:58:43)\\n\\n  \\u25cf SessionDiscovery \\u203a findSessions \\u203a should skip unreadable files without error\\n\\n    expect(received).toBe(expected) // Object.is equality\\n\\n    Expected: 1\\n    Received: 3\\n\\n      81 |             const sessions = await discovery.findSessions();\\n      82 |\\n    > 83 |             expect(sessions.length).toBe(1);\\n         |                                     ^\\n      84 |             expect(sessions[0].sessionId).toBe('good');\\n      85 |         });\\n      86 |     });\\n\\n      at Object.<anonymous> (tests/unit/state-bridge/session-discovery.test.ts:83:37)\\n\\n  \\u25cf SessionDiscovery \\u203a getLatestSession \\u203a should return the most recent session\\n\\n    expect(received).toBe(expected) // Object.is equality\\n\\n    Expected: \\\"newest\\\"\\n    Received: \\\"older\\\"\\n\\n      104 |             const session = await discovery.getLatestSession();\\n      105 |\\n    > 106 |             expect(session?.sessionId).toBe('newest');\\n          |                                        ^\\n      107 |         });\\n      108 |     });\\n      109 |\\n\\n      at Object.<anonymous> (tests/unit/state-bridge/session-discovery.test.ts:106:40)\\n\\n  \\u25cf SessionDiscovery \\u203a caching \\u203a should cache results for 60 seconds\\n\\n    expect(jest.fn()).toHaveBeenCalledTimes(expected)\\n\\n    Expected number of calls: 1\\n    Received number of calls: 2\\n\\n      140 |\\n      141 |             // readdirSync should only be called once due to caching\\n    > 142 |             expect(mockFs.readdirSync).toHaveBeenCalledTimes(1);\\n          |                                        ^\\n      143 |         });\\n      144 |\\n      145 |         it('should clear cache when clearCache is called', async () => {\\n\\n      at Object.<anonymous> (tests/unit/state-bridge/session-discovery.test.ts:142:40)\\n\\n  \\u25cf SessionDiscovery \\u203a caching \\u203a should clear cache when clearCache is called\\n\\n    expect(jest.fn()).toHaveBeenCalledTimes(expected)\\n\\n    Expected number of calls: 2\\n    Received number of calls: 4\\n\\n      152 |             await discovery.findSessions();\\n      153 |\\n    > 154 |             expect(mockFs.readdirSync).toHaveBeenCalledTimes(2);\\n          |                                        ^\\n      155 |         });\\n      156 |     });\\n      157 | });\\n\\n      at Object.<anonymous> (tests/unit/state-bridge/session-discovery.test.ts:154:40)\\n\\nPASS tests/unit/state-bridge/session-parser.test.ts\\nPASS tests/unit/state-bridge/context-injector.test.ts\\nJest: \\\"global\\\" coverage threshold for branches (80%) not met: 61.36%\\n\\nTest Suites: 1 failed, 2 passed, 3 total\\nTests:       6 failed, 31 passed, 37 total\\nSnapshots:   0 total\\nTime:        0.745 s, estimated 1 s\\nRan all test suites.\\nTest results written to: test-results.json\\n\", \"stderr\": \"sh: 1: Bad substitution\\n\", \"success\": false}"
}